<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyphonic MIDI Piano Keyboard with Pitch Practice</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* Custom styles for the piano keyboard and practice section */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        #piano-container {
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #piano-container::-webkit-scrollbar {
            display: none;
        }

        #notes-container {
            display: inline-flex;
            align-items: flex-start;
            padding: 2rem 1rem;
            background-color: #1a202c;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 2px solid #4a5568;
        }

        .key {
            position: relative;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            box-sizing: border-box;
            transition: filter 0.1s ease-in-out;
        }
        
        .key.pressed, .key:active {
            filter: brightness(1.3);
        }

        .white-key {
            width: 50px;
            height: 220px;
            border: 1px solid #4a5568;
            border-radius: 0 0 6px 6px;
            box-shadow: inset 0 1px 5px rgba(255, 255, 255, 0.1), 0 5px 8px rgba(0,0,0,0.4);
            padding-bottom: 0.5rem;
        }

        .black-key {
            width: 30px;
            height: 130px;
            border-radius: 0 0 4px 4px;
            z-index: 10;
            margin-left: -15px;
            margin-right: -15px;
            box-shadow: inset 0 -8px 5px rgba(0,0,0,0.5), 0 3px 5px rgba(0,0,0,0.5);
            padding-bottom: 0.5rem;
        }

        .key-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex flex-col h-screen">

    <!-- Main container for the app -->
    <div id="app-container" class="hidden flex-col h-full">
        <header class="container mx-auto p-4 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Pitch Matching Practice</h1>
            <p class="text-md text-gray-600 dark:text-gray-400 mt-2">Listen to the random pitch, find it on the keyboard, then reveal the answer.</p>
        </header>

        <!-- Pitch Practice Controls -->
        <section id="practice-section" class="container mx-auto p-4 bg-gray-200 dark:bg-gray-800 rounded-lg shadow-md mb-4">
            <div class="flex flex-wrap items-center justify-center gap-4">
                <!-- Buttons -->
                <button id="play-random-pitch-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Play Random Pitch</button>
                <button id="reveal-pitch-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Reveal Pitch</button>
                
                <!-- Dropdowns -->
                <div class="flex items-center gap-2">
                    <label for="min-pitch-select" class="font-semibold">Min:</label>
                    <select id="min-pitch-select" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-2"></select>
                </div>
                <div class="flex items-center gap-2">
                    <label for="max-pitch-select" class="font-semibold">Max:</label>
                    <select id="max-pitch-select" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-2"></select>
                </div>
            </div>
            <div id="reveal-message" class="text-center mt-4 text-xl font-bold text-blue-500 hidden"></div>
        </section>

        <!-- Piano Container -->
        <!-- SCROLL FIX: Removed 'justify-center' to allow full scrolling from left to right -->
        <div id="piano-container" class="w-full flex-grow flex items-center">
            <div id="notes-container">
                <!-- Piano keys will be dynamically generated here -->
            </div>
        </div>
    </div>
    
    <!-- Start Screen -->
    <div id="start-screen" class="flex-grow flex items-center justify-center">
        <button id="start-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 text-xl">
            Click to Start
        </button>
    </div>

    <script type="module">
        // Log to confirm the script has started
        console.log("Script execution started.");

        // Import the color conversion function from the external module
        import { getMidiNoteColor } from 'https://cdn.jsdelivr.net/gh/JotaGreen/keytap@main/midiColorConverter.js';
        console.log("Successfully imported getMidiNoteColor function.");

        // --- DOM Elements ---
        const startButton = document.getElementById('start-button');
        const startScreen = document.getElementById('start-screen');
        const appContainer = document.getElementById('app-container');
        const pianoContainer = document.getElementById('piano-container');
        const notesContainer = document.getElementById('notes-container');
        const playRandomPitchBtn = document.getElementById('play-random-pitch-btn');
        const revealPitchBtn = document.getElementById('reveal-pitch-btn');
        const revealMessage = document.getElementById('reveal-message');
        const minPitchSelect = document.getElementById('min-pitch-select');
        const maxPitchSelect = document.getElementById('max-pitch-select');

        // --- State Variables ---
        let synth;
        let currentRandomMidiNote = null;
        const minMidi = 24; // C1
        const maxMidi = 108; // C8

        // --- Utility Functions ---
        function midiToPitchName(midiNote) {
            const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            const octave = Math.floor(midiNote / 12) - 1;
            const noteIndex = midiNote % 12;
            return `${noteNames[noteIndex]}${octave}`;
        }

        // --- App Initialization ---
        startButton.addEventListener('click', async () => {
            console.log("Start button clicked. Initializing audio and app.");
            try {
                await Tone.start();
                console.log("AudioContext started successfully.");
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                console.log("Tone.PolySynth initialized.");
                
                startScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');

                populatePitchSelectors();
                generatePianoKeys();
                setNewRandomNote();

            } catch (error) {
                console.error("Error starting Tone.js:", error);
                // A simple error message for the user without using alert()
                appContainer.innerHTML = `<div class="text-center text-red-500">Failed to initialize audio. Please refresh the page.</div>`;
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
            }
        });

        // --- Pitch Practice Logic ---
        function populatePitchSelectors() {
            for (let midi = minMidi; midi <= maxMidi; midi++) {
                const pitchName = midiToPitchName(midi);
                const optionMin = new Option(pitchName, midi);
                const optionMax = new Option(pitchName, midi);
                minPitchSelect.add(optionMin);
                maxPitchSelect.add(optionMax);
            }
            minPitchSelect.value = 48; // Default C3
            maxPitchSelect.value = 72; // Default C5
        }

        function setNewRandomNote() {
            const min = parseInt(minPitchSelect.value);
            const max = parseInt(maxPitchSelect.value);
            
            // Generate a random integer between min and max (inclusive)
            const randomMidi = Math.floor(Math.random() * (max - min + 1)) + min;
            currentRandomMidiNote = randomMidi;
            
            console.log(`New random note set: ${midiToPitchName(currentRandomMidiNote)} (MIDI: ${currentRandomMidiNote})`);
            
            // Reset the UI
            revealMessage.classList.add('hidden');
            revealPitchBtn.textContent = 'Reveal Pitch';
        }

        playRandomPitchBtn.addEventListener('click', () => {
            if (synth && currentRandomMidiNote !== null) {
                const pitchName = midiToPitchName(currentRandomMidiNote);
                console.log(`Playing random note: ${pitchName}`);
                synth.triggerAttackRelease(pitchName, '1s');
            }
        });

        revealPitchBtn.addEventListener('click', () => {
            if (revealPitchBtn.textContent === 'Reveal Pitch') {
                const pitchName = midiToPitchName(currentRandomMidiNote);
                revealMessage.textContent = `The note was: ${pitchName}`;
                revealMessage.classList.remove('hidden');
                revealPitchBtn.textContent = 'New Pitch';
            } else {
                setNewRandomNote();
            }
        });

        minPitchSelect.addEventListener('change', () => {
            // Ensure min is not greater than max
            if (parseInt(minPitchSelect.value) > parseInt(maxPitchSelect.value)) {
                maxPitchSelect.value = minPitchSelect.value;
            }
            setNewRandomNote();
        });

        maxPitchSelect.addEventListener('change', () => {
            // Ensure max is not less than min
            if (parseInt(maxPitchSelect.value) < parseInt(minPitchSelect.value)) {
                minPitchSelect.value = maxPitchSelect.value;
            }
            setNewRandomNote();
        });

        // --- Piano Key Generation ---
        function generatePianoKeys() {
            if (!notesContainer) {
                console.error("Could not find the 'notes-container' element in the DOM.");
                return;
            }
            
            console.log("Starting to generate piano keys.");
            
            for (let midi = minMidi; midi <= maxMidi; midi++) {
                const pitchName = midiToPitchName(midi);
                const isBlackKey = pitchName.includes('#');
                const key = document.createElement('div');
                key.className = 'key ' + (isBlackKey ? 'black-key' : 'white-key');

                const [r, g, b] = getMidiNoteColor(midi);
                key.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                
                const label = document.createElement('span');
                label.className = 'key-label';
                label.textContent = pitchName;
                key.appendChild(label);

                const playNote = (e) => {
                    e.preventDefault();
                    if (synth && !key.classList.contains('pressed')) {
                        synth.triggerAttack(pitchName);
                        key.classList.add('pressed');
                    }
                };

                const stopNote = () => {
                    if (synth && key.classList.contains('pressed')) {
                        synth.triggerRelease(pitchName);
                        key.classList.remove('pressed');
                    }
                };
                
                key.addEventListener('mousedown', playNote);
                key.addEventListener('mouseup', stopNote);
                key.addEventListener('mouseleave', stopNote);
                key.addEventListener('touchstart', playNote);
                key.addEventListener('touchend', stopNote);
                key.addEventListener('touchcancel', stopNote);

                notesContainer.appendChild(key);
            }
            
            console.log("Finished generating all piano keys.");
        }
    </script>

</body>
</html>
