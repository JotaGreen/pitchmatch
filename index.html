<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyphonic MIDI Piano Keyboard with Color and Sound</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* Custom styles for the piano keyboard */
        body {
            /* Use a default system font stack for better performance and no external dependencies */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            /* Prevent body scrolling while scrolling the piano */
            overflow: hidden;
            /* Prevent text selection on the piano keys */
            user-select: none;
            -webkit-user-select: none;
        }

        #piano-container {
            /* Enable horizontal scrolling for the piano */
            overflow-x: auto;
            /* Hide scrollbar for a cleaner look */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #piano-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }

        #notes-container {
            display: inline-flex; /* Use inline-flex to allow the container to size to its content */
            align-items: flex-start; /* Align keys to the top */
            padding: 2rem 1rem;
            background-color: #1a202c;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 2px solid #4a5568;
        }

        .key {
            position: relative;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            box-sizing: border-box;
            transition: filter 0.1s ease-in-out;
        }
        
        .key.pressed, .key:active {
            /* Make the key look pressed */
            filter: brightness(1.3);
        }

        .white-key {
            width: 50px;
            height: 220px;
            border: 1px solid #4a5568;
            border-radius: 0 0 6px 6px;
            box-shadow: inset 0 1px 5px rgba(255, 255, 255, 0.1), 0 5px 8px rgba(0,0,0,0.4);
            padding-bottom: 0.5rem;
        }

        .black-key {
            width: 30px;
            height: 130px;
            border-radius: 0 0 4px 4px;
            z-index: 10;
            /* The negative margin trick pulls the black key over the white keys */
            margin-left: -15px;
            margin-right: -15px;
            box-shadow: inset 0 -8px 5px rgba(0,0,0,0.5), 0 3px 5px rgba(0,0,0,0.5);
            padding-bottom: 0.5rem;
        }

        .key-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            /* Prevent the label from interfering with click events on the key */
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex flex-col h-screen">

    <div class="container mx-auto p-4 md:p-8 text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Polyphonic MIDI Piano Keyboard</h1>
        <p class="text-md text-gray-600 dark:text-gray-400 mt-2">A colored piano keyboard from C1 to C8. Press and hold to play chords.</p>
    </div>
    
    <!-- Start button to initialize audio context -->
    <div id="start-screen" class="flex-grow flex items-center justify-center">
        <button id="start-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 text-xl">
            Click to Start
        </button>
    </div>
    
    <!-- Container for the piano keyboard (initially hidden) -->
    <div id="piano-container" class="w-full hidden flex-grow items-center justify-center">
        <div id="notes-container">
            <!-- Piano keys will be dynamically generated and inserted here -->
        </div>
    </div>

    <script type="module">
        // Log to confirm the script has started
        console.log("Script execution started.");

        // Import the color conversion function from the external module
        import { getMidiNoteColor } from 'https://cdn.jsdelivr.net/gh/JotaGreen/keytap@main/midiColorConverter.js';
        console.log("Successfully imported getMidiNoteColor function.");

        /**
         * Converts a MIDI note number to its standard pitch name (e.g., 60 -> "C4").
         * @param {number} midiNote - The MIDI note number (0-127).
         * @returns {string} The name of the pitch (e.g., "A#4").
         */
        function midiToPitchName(midiNote) {
            const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            const octave = Math.floor(midiNote / 12) - 1;
            const noteIndex = midiNote % 12;
            return `${noteNames[noteIndex]}${octave}`;
        }

        const startButton = document.getElementById('start-button');
        const pianoContainer = document.getElementById('piano-container');
        const notesContainer = document.getElementById('notes-container');
        const startScreen = document.getElementById('start-screen');

        let synth;

        // Event listener for the start button
        startButton.addEventListener('click', async () => {
            console.log("Start button clicked. Initializing audio.");
            try {
                await Tone.start();
                console.log("AudioContext started successfully.");
                
                // --- KEY CHANGE: Use PolySynth for multiple notes ---
                // This creates a synth that can play multiple notes at once.
                // It manages a pool of Tone.Synth instances.
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                console.log("Tone.PolySynth initialized.");
                
                startScreen.classList.add('hidden');
                pianoContainer.classList.remove('hidden');
                pianoContainer.classList.add('flex');

                generatePianoKeys();
            } catch (error) {
                console.error("Error starting Tone.js:", error);
                alert("Could not initialize audio. Please refresh the page and try again.");
            }
        });

        function generatePianoKeys() {
            if (!notesContainer) {
                console.error("Could not find the 'notes-container' element in the DOM.");
                return;
            }
            
            console.log("Found 'notes-container'. Starting to generate piano keys.");
            
            const minMidi = 24; // C1
            const maxMidi = 108; // C8

            for (let midi = minMidi; midi <= maxMidi; midi++) {
                const pitchName = midiToPitchName(midi);
                const isBlackKey = pitchName.includes('#');
                const key = document.createElement('div');
                key.className = 'key ' + (isBlackKey ? 'black-key' : 'white-key');

                const [r, g, b] = getMidiNoteColor(midi);
                key.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                
                const label = document.createElement('span');
                label.className = 'key-label';
                label.textContent = pitchName;
                key.appendChild(label);

                // --- Event Listeners for sustained, polyphonic notes ---

                const playNote = (e) => {
                    e.preventDefault();
                    if (synth && !key.classList.contains('pressed')) {
                        console.log(`Attack: ${pitchName}`);
                        // triggerAttack is the same for PolySynth
                        synth.triggerAttack(pitchName);
                        key.classList.add('pressed');
                    }
                };

                const stopNote = () => {
                    if (synth && key.classList.contains('pressed')) {
                        console.log(`Release: ${pitchName}`);
                        // --- KEY CHANGE: Specify which note to release ---
                        // This ensures only the key being released is silenced.
                        synth.triggerRelease(pitchName);
                        key.classList.remove('pressed');
                    }
                };
                
                // Mouse events
                key.addEventListener('mousedown', playNote);
                key.addEventListener('mouseup', stopNote);
                key.addEventListener('mouseleave', stopNote);

                // Touch events
                key.addEventListener('touchstart', playNote);
                key.addEventListener('touchend', stopNote);
                key.addEventListener('touchcancel', stopNote);

                notesContainer.appendChild(key);
            }
            
            console.log("Finished generating all piano keys.");
        }
    </script>

</body>
</html>
